{% extends "base.html" %}
{% load static %}

{% block title %}ç»æœŸç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- æ—¥å†éƒ¨åˆ† -->
        <div class="col-md-8">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>{{ current_year }}å¹´{{ current_month }}æœˆ</h2>
                    <div class="btn-group">
                        <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-default">&lt; ä¸Šæœˆ</a>
                        <!-- æ·»åŠ "ä»Šå¤©"æŒ‰é’® -->
                        <button id="todayBtn" class="btn btn-info">ä»Šå¤©</button>
                        <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-default">ä¸‹æœˆ &gt;</a>
                    </div>


                    {% if user.is_authenticated %}
                    <button type="button" class="btn btn-pink" data-toggle="modal" data-target="#profileModal">
                        è®¾ç½®åŸºç¡€ä¿¡æ¯
                    </button>
                    {% endif %}
                </div>

                <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
                <div id="debugPanel" class="debug-panel"
                     style="display: none; background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #ff6b9d;">
                    <h5>ğŸ” é¢„æµ‹è°ƒè¯•ä¿¡æ¯</h5>
                    <div id="debugInfo"
                         style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4;">
                        <p class="text-muted">ç‚¹å‡»æ—¥æœŸæŸ¥çœ‹è¯¦ç»†é¢„æµ‹ä¿¡æ¯...</p>
                    </div>
                </div>

                <div class="calendar">
                    <div class="calendar-weekdays">
                        <div class="weekday">æ—¥</div>
                        <div class="weekday">ä¸€</div>
                        <div class="weekday">äºŒ</div>
                        <div class="weekday">ä¸‰</div>
                        <div class="weekday">å››</div>
                        <div class="weekday">äº”</div>
                        <div class="weekday">å…­</div>
                    </div>

                    <div class="calendar-days">
                        {% for week in calendar_data %}
                        <div class="calendar-week">
                            {% for day in week %}
                            <div class="calendar-day
                                 {% if not day.current_month %}other-month{% endif %}
                                 {% if day.is_period %}period-day{% endif %}
                                 {% if day.is_current_prediction %}current-prediction{% endif %}
                                 {% if day.is_next_prediction %}next-prediction{% endif %}
                                 {% if day.is_today %}today-day{% endif %}
                                 {% if day.is_future %}future-day non-clickable{% else %}clickable-day{% endif %}"
                                 data-date="{% if day.date %}{{ day.date.isoformat }}{% endif %}"
                                 data-day="{{ day.day }}"
                                 data-current-month="{{ day.current_month }}"
                                 data-is-future="{{ day.is_future }}"
                                 data-is-period="{{ day.is_period }}"
                                 data-is-current-prediction="{{ day.is_current_prediction }}"
                                 data-is-next-prediction="{{ day.is_next_prediction }}">

                                {{ day.day }}

                                <!-- é¢„æµ‹æ ‡è®° -->
                                {% if day.is_current_prediction %}
                                <div class="prediction-indicator current">é¢„</div>
                                {% endif %}

                                {% if day.is_next_prediction %}
                                <div class="prediction-indicator next">é¢„</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- å›¾ä¾‹ -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-color period-color"></span>
                        <span class="legend-text">ç»æœŸ</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color prediction-current-color"></span>
                        <span class="legend-text">å½“å‰é¢„æµ‹</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color prediction-next-color"></span>
                        <span class="legend-text">ä¸‹æ¬¡é¢„æµ‹</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color future-color"></span>
                        <span class="legend-text">æœªæ¥æ—¥æœŸï¼ˆä¸å¯æ ‡è®°ï¼‰</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»æœŸè®°å½•åˆ—è¡¨ -->
        <div class="col-md-4">
            <div class="period-records-panel">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">ç»æœŸè®°å½•</h3>
                    </div>
                    <div class="panel-body">
                        {% if user.is_authenticated %}
                            {% if period_records %}
                                <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
                                <div class="batch-operations-toolbar" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                                    <div class="row">
                                        <div class="col-xs-6">
                                            <div class="checkbox" style="margin: 0;">
                                                <label>
                                                    <input type="checkbox" id="selectAllRecords"> å…¨é€‰
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-xs-6 text-right">
                                            <span class="selected-count" style="margin-right: 10px;">
                                                å·²é€‰æ‹© <strong id="selectedCount">0</strong> æ¡è®°å½•
                                            </span>
                                            <button class="btn btn-danger btn-sm" id="batchDeleteBtn" disabled>
                                                <i class="glyphicon glyphicon-trash"></i> æ‰¹é‡åˆ é™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="records-list">
                                    {% for record in period_records %}
                                    <div class="record-item" data-record-id="{{ record.id }}">
                                        <div class="record-checkbox">
                                            <input type="checkbox" class="record-checkbox-input" value="{{ record.id }}">
                                        </div>
                                        <div class="record-content">
                                            <span class="record-date">
                                                {{ record.start_date|date:"Y-m-d" }} è‡³ {{ record.end_date|date:"Y-m-d" }}
                                                {% if record.is_predicted %}
                                                <span class="label label-info">é¢„æµ‹</span>
                                                {% else %}
                                                <span class="label label-success">ç¡®è®¤</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="record-actions">
                                            <button class="btn btn-danger btn-xs delete-record"
                                                    data-record-id="{{ record.id }}"
                                                    title="åˆ é™¤è®°å½•">
                                                Ã—
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">æš‚æ— ç»æœŸè®°å½•</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">è¯·å…ˆç™»å½•æŸ¥çœ‹ç»æœŸè®°å½•</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥æœŸè¯¦æƒ…é¢æ¿ -->
<div id="datePanel" class="date-panel" style="display: none;">
    <div class="panel-header">
        <h4>æ—¥æœŸè¯¦æƒ…</h4>
        <button type="button" class="close" id="closePanel">&times;</button>
    </div>
    <div class="panel-body">
        <div class="selected-date">
            <strong>é€‰ä¸­çš„æ—¥æœŸï¼š</strong>
            <span id="selectedDateText"></span>
        </div>
        <div class="date-actions" id="dateActions">
            <!-- è¿™é‡Œä¼šæ ¹æ®æ—¥æœŸçŠ¶æ€åŠ¨æ€æ˜¾ç¤ºä¸åŒçš„æŒ‰é’® -->
        </div>
    </div>
</div>

<!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="batchDeleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">ç¡®è®¤æ‰¹é‡åˆ é™¤</h4>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <strong id="deleteCount">0</strong> æ¡ç»æœŸè®°å½•å—ï¼Ÿ</p>
                <p class="text-danger"><small>æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œã€‚</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmBatchDelete">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>


<!-- é¢„æµ‹ä¿¡æ¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="predictionsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">ç»æœŸé¢„æµ‹</h4>
            </div>
            <div class="modal-body">
                <div id="predictionsContent">
                    <p class="text-muted">åŠ è½½ä¸­...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- è¦†ç›–å±‚ -->
<div id="overlay" style="display: none;"></div>

<!-- åŸºç¡€ä¿¡æ¯æ¨¡æ€æ¡† -->
{% if user.is_authenticated %}
<div class="modal fade" id="profileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">åŸºç¡€ä¿¡æ¯è®¾ç½®</h4>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="cycle_length">æœˆç»é—´éš”å¤©æ•° (15-45å¤©)</label>
                        <select class="form-control" id="cycle_length" name="cycle_length" required>
                            <option value="">è¯·é€‰æ‹©</option>

                            <!-- 15-23å¤©é€‰é¡¹ -->
                            {% for day_num in range_15_23 %}
                            <option value="{{ day_num }}"
                                    {% if user_profile.cycle_length == day_num %}selected{% endif %}>
                                {{ day_num }}å¤©
                            </option>
                            {% endfor %}

                            <!-- 24-32å¤©é€‰é¡¹ -->
                            {% for day_num in range_24_32 %}
                            <option value="{{ day_num }}"
                                    {% if user_profile.cycle_length == day_num %}selected{% endif %}>
                                {{ day_num }}å¤©
                            </option>
                            {% endfor %}

                            <!-- 33-41å¤©é€‰é¡¹ -->
                            {% for day_num in range_33_41 %}
                            <option value="{{ day_num }}"
                                    {% if user_profile.cycle_length == day_num %}selected{% endif %}>
                                {{ day_num }}å¤©
                            </option>
                            {% endfor %}

                            <!-- 42-45å¤©é€‰é¡¹ -->
                            {% for day_num in range_42_45 %}
                            <option value="{{ day_num }}"
                                    {% if user_profile.cycle_length == day_num %}selected{% endif %}>
                                {{ day_num }}å¤©
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="period_length">ç»æœŸæŒç»­å¤©æ•° (1-10å¤©)</label>
                        <select class="form-control" id="period_length" name="period_length" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            {% for i in range_1_10 %}
                            <option value="{{ i }}"
                                    {% if user_profile.period_length == i %} selected {% endif %}>
                                {{ i }}å¤©
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-pink" id="saveProfile">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // ä¼ é€’ç™»å½•çŠ¶æ€åˆ°JavaScript
    var isUserAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
    var currentUser = "{{ user.username }}";

    $(document).ready(function() {
        console.log("=== æ–‡æ¡£åŠ è½½å®Œæˆ - ç»æœŸç®¡ç†ç³»ç»Ÿå·²å¯åŠ¨ ===");


        // å¤šé€‰åˆ é™¤åŠŸèƒ½
        var selectedRecords = new Set();

        // æ˜¾ç¤º/éšè—æ‰¹é‡æ“ä½œå·¥å…·æ 
        function toggleBatchToolbar() {
            var $toolbar = $('.batch-operations-toolbar');
            if ($('.record-checkbox-input').length > 0) {
                $toolbar.show();
            } else {
                $toolbar.hide();
            }
        }
        // æ›´æ–°é€‰ä¸­è®¡æ•°
        function updateSelectedCount() {
            var count = selectedRecords.size;
            $('#selectedCount').text(count);
            $('#batchDeleteBtn').prop('disabled', count === 0);

            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            var totalRecords = $('.record-checkbox-input').length;
            $('#selectAllRecords').prop('checked', count > 0 && count === totalRecords);
        }
        // å•ä¸ªè®°å½•å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶
        $(document).on('change', '.record-checkbox-input', function() {
            var recordId = $(this).val();

            if ($(this).is(':checked')) {
                selectedRecords.add(recordId);
                $(this).closest('.record-item').addClass('selected');
            } else {
                selectedRecords.delete(recordId);
                $(this).closest('.record-item').removeClass('selected');
            }

            updateSelectedCount();
        });

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        $('#selectAllRecords').on('change', function() {
            var isChecked = $(this).is(':checked');

            $('.record-checkbox-input').prop('checked', isChecked).trigger('change');

            if (isChecked) {
                $('.record-checkbox-input').each(function() {
                    selectedRecords.add($(this).val());
                });
                $('.record-item').addClass('selected');
            } else {
                selectedRecords.clear();
                $('.record-item').removeClass('selected');
            }

            updateSelectedCount();
        });

        // æ‰¹é‡åˆ é™¤æŒ‰é’®ç‚¹å‡»
        $('#batchDeleteBtn').on('click', function() {
            if (selectedRecords.size === 0) return;

            $('#deleteCount').text(selectedRecords.size);
            $('#batchDeleteModal').modal('show');
        });

        // ç¡®è®¤æ‰¹é‡åˆ é™¤
        $('#confirmBatchDelete').on('click', function() {
            var recordIds = Array.from(selectedRecords);
            var totalRecords = recordIds.length;
            var deletedCount = 0;
            var errors = [];

            $('#confirmBatchDelete').prop('disabled', true).html('<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> åˆ é™¤ä¸­...');

            // ä¾æ¬¡åˆ é™¤æ¯ä¸ªé€‰ä¸­çš„è®°å½•
            function deleteNextRecord() {
                if (deletedCount >= totalRecords) {
                    // æ‰€æœ‰è®°å½•åˆ é™¤å®Œæˆ
                    $('#batchDeleteModal').modal('hide');
                    $('#confirmBatchDelete').prop('disabled', false).text('ç¡®è®¤åˆ é™¤');

                    if (errors.length === 0) {
                        alert('æˆåŠŸåˆ é™¤ ' + totalRecords + ' æ¡è®°å½•ï¼');
                        location.reload();
                    } else {
                        alert('åˆ é™¤å®Œæˆï¼Œä½†æœ‰ ' + errors.length + ' æ¡è®°å½•åˆ é™¤å¤±è´¥ï¼š\n' + errors.join('\n'));
                        location.reload();
                    }
                    return;
                }

                var recordId = recordIds[deletedCount];

                $.ajax({
                    url: '/period/delete/' + recordId + '/',
                    type: 'POST',
                    data: {
                        'csrfmiddlewaretoken': getCSRFToken()
                    },
                    success: function(data) {
                        if (data.success) {
                            console.log('è®°å½• ' + recordId + ' åˆ é™¤æˆåŠŸ');
                        } else {
                            errors.push('è®°å½• ' + recordId + ': ' + data.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        errors.push('è®°å½• ' + recordId + ': ' + error);
                    },
                    complete: function() {
                        deletedCount++;
                        // æ›´æ–°è¿›åº¦
                        var progress = Math.round((deletedCount / totalRecords) * 100);
                        $('#confirmBatchDelete').html('<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> åˆ é™¤ä¸­... (' + progress + '%)');
                        deleteNextRecord();
                    }
                });
            }

            // å¼€å§‹åˆ é™¤
            deleteNextRecord();
        });
        // åˆå§‹åŒ–æ‰¹é‡æ“ä½œå·¥å…·æ 
        toggleBatchToolbar();


        // è°ƒè¯•é¢æ¿å¼€å…³
        var debugPanelVisible = false;
        $('#toggleDebugPanel').on('click', function() {
            debugPanelVisible = !debugPanelVisible;
            if (debugPanelVisible) {
                $('#debugPanel').show();
                $(this).html('éšè—è°ƒè¯•');
            } else {
                $('#debugPanel').hide();
                $(this).html('è°ƒè¯•ä¿¡æ¯');
            }
        });

        // ä»Šå¤©æŒ‰é’®åŠŸèƒ½
        $('#todayBtn').on('click', function() {
            var today = new Date();
            var currentYear = today.getFullYear();
            var currentMonth = today.getMonth() + 1;

            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å½“å‰æœˆä»½
            var currentDisplayYear = {{ current_year }};
            var currentDisplayMonth = {{ current_month }};

            if (currentDisplayYear === currentYear && currentDisplayMonth === currentMonth) {
                // å·²ç»åœ¨å½“å‰æœˆä»½ï¼Œé«˜äº®ä»Šå¤©
                highlightToday();
            } else {
                // è·³è½¬åˆ°å½“å‰æœˆä»½
                window.location.href = '?year=' + currentYear + '&month=' + currentMonth;
            }
        });

        // é«˜äº®ä»Šå¤©çš„æ—¥æœŸ
        function highlightToday() {
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            $('.today-highlight').removeClass('today-highlight today-highlight-animate');

            var today = new Date();
            var todayFormatted = today.toISOString().split('T')[0];

            var todayElement = $('.calendar-day[data-date="' + todayFormatted + '"]');

            if (todayElement.length > 0) {
                // æ·»åŠ é«˜äº®ç±»
                todayElement.addClass('today-highlight today-highlight-animate');

                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                todayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // 3ç§’åç§»é™¤åŠ¨ç”»ç±»ï¼Œä¿ç•™é™æ€é«˜äº®
                setTimeout(function() {
                    todayElement.removeClass('today-highlight-animate');
                }, 3000);
            }
        }

        // æ—¥æœŸç‚¹å‡»åŠŸèƒ½ - ä¿®å¤ç‰ˆæœ¬ï¼šæœªæ¥æ—¥æœŸä¸å¯ç‚¹å‡»
        $(document).on('click', '.calendar-day', function(event) {
            console.log("=== æ—¥æœŸç‚¹å‡»äº‹ä»¶å¼€å§‹ ===");
            event.stopPropagation();

            var $this = $(this);
            var dateStr = $this.data('date');
            var day = $this.data('day');
            var isCurrentMonth = $this.data('current-month');
            var isFuture = $this.data('is-future');
            var isPeriod = $this.data('is-period');
            var isCurrentPrediction = $this.data('is-current-prediction');
            var isNextPrediction = $this.data('is-next-prediction');

            console.log("ç‚¹å‡»çš„æ—¥æœŸæ•°æ®:", {
                dateStr: dateStr,
                day: day,
                isCurrentMonth: isCurrentMonth,
                isFuture: isFuture,
                isPeriod: isPeriod,
                isCurrentPrediction: isCurrentPrediction,
                isNextPrediction: isNextPrediction
            });

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            showDebugInfo({
                date: dateStr,
                day: day,
                isCurrentMonth: isCurrentMonth,
                isFuture: isFuture,
                isPeriod: isPeriod,
                isCurrentPrediction: isCurrentPrediction,
                isNextPrediction: isNextPrediction
            });

            // æ£€æŸ¥æ˜¯å¦ä¸ºæœªæ¥æ—¥æœŸ - å¦‚æœæ˜¯æœªæ¥æ—¥æœŸï¼Œç›´æ¥è¿”å›ï¼Œä¸å¼¹å‡ºå¼¹çª—
            if (isFuture === true || isFuture === 'true') {
                console.log("æœªæ¥æ—¥æœŸï¼Œç¦æ­¢ç‚¹å‡»");
                addDebugInfo("æœªæ¥æ—¥æœŸï¼Œç¦æ­¢ç‚¹å‡»");
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ
            if (!dateStr || dateStr === '' || dateStr === 'None') {
                console.log("æ— æ•ˆæ—¥æœŸï¼Œè·³è¿‡");
                addDebugInfo("æ— æ•ˆæ—¥æœŸï¼Œè·³è¿‡");
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰æœˆ
            if (isCurrentMonth === false || isCurrentMonth === 'false') {
                console.log("éå½“å‰æœˆæ—¥æœŸï¼Œè·³è¿‡");
                addDebugInfo("éå½“å‰æœˆæ—¥æœŸï¼Œè·³è¿‡");
                return;
            }

            console.log("å¤„ç†æœ‰æ•ˆæ—¥æœŸ:", dateStr);
            addDebugInfo("å¤„ç†æœ‰æ•ˆæ—¥æœŸ: " + dateStr);

            try {
                // å®‰å…¨è§£ææ—¥æœŸ
                var dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    console.error("æ—¥æœŸæ ¼å¼é”™è¯¯:", dateStr);
                    addDebugInfo("æ—¥æœŸæ ¼å¼é”™è¯¯: " + dateStr);
                    return;
                }

                var year = parseInt(dateParts[0]);
                var month = parseInt(dateParts[1]) - 1;
                var day = parseInt(dateParts[2]);

                var date = new Date(year, month, day);
                if (isNaN(date.getTime())) {
                    console.error("æ— æ•ˆçš„æ—¥æœŸå¯¹è±¡");
                    addDebugInfo("æ— æ•ˆçš„æ—¥æœŸå¯¹è±¡");
                    return;
                }

                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                var formattedDate = date.getFullYear() + 'å¹´' +
                                   (date.getMonth() + 1) + 'æœˆ' +
                                   date.getDate() + 'æ—¥ (' +
                                   getWeekday(date.getDay()) + ')';

                console.log("æ ¼å¼åŒ–æ—¥æœŸ:", formattedDate);
                addDebugInfo("æ ¼å¼åŒ–æ—¥æœŸ: " + formattedDate);

                // æ˜¾ç¤ºé€‰ä¸­çš„æ—¥æœŸ
                $('#selectedDateText').text(formattedDate);

                // è·å–è¯¥æ—¥æœŸçš„ç»æœŸä¿¡æ¯
                $.get('/period/info/', {date: dateStr}, function(data) {
                    if (data.success) {
                        addDebugInfo("è·å–ç»æœŸä¿¡æ¯æˆåŠŸ");
                        updateDatePanel(dateStr, data);
                    } else {
                        console.error("è·å–ç»æœŸä¿¡æ¯å¤±è´¥:", data.message);
                        addDebugInfo("è·å–ç»æœŸä¿¡æ¯å¤±è´¥: " + data.message);
                        // æ˜¾ç¤ºåŸºæœ¬æ“ä½œ
                        showBasicDatePanel(dateStr);
                    }
                }).fail(function() {
                    // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºåŸºæœ¬æ“ä½œ
                    addDebugInfo("è·å–ç»æœŸä¿¡æ¯è¯·æ±‚å¤±è´¥");
                    showBasicDatePanel(dateStr);
                });

            } catch (error) {
                console.error("æ—¥æœŸå¤„ç†é”™è¯¯:", error);
                addDebugInfo("æ—¥æœŸå¤„ç†é”™è¯¯: " + error);
                // æ˜¾ç¤ºåŸºæœ¬æ“ä½œä½œä¸ºåå¤‡
                showBasicDatePanel(dateStr);
            }
        });



        // æ›´æ–°æ—¥æœŸé¢æ¿å†…å®¹
        function updateDatePanel(dateStr, data) {
            console.log("æ›´æ–°æ—¥æœŸé¢æ¿:", dateStr, data);
            addDebugInfo("æ›´æ–°æ—¥æœŸé¢æ¿: " + dateStr);

            var actionsHtml = '';
            var hasStartButton = false;

            if (isUserAuthenticated) {
                if (data.is_start_possible && !hasStartButton) {
                    actionsHtml += '<button class="btn btn-pink btn-sm mb-2" id="setPeriodStart" data-date="' + dateStr + '">æ ‡è®°ç»æœŸå¼€å§‹</button>';
                    hasStartButton = true;
                    addDebugInfo("æ˜¾ç¤ºæ ‡è®°ç»æœŸå¼€å§‹æŒ‰é’®");
                }

                // ç»æœŸè®°å½•è°ƒæ•´é€‰é¡¹
                if (data.end_candidate_records && data.end_candidate_records.length > 0) {
                    actionsHtml += '<div class="period-adjustment-options">';
                    actionsHtml += '<p class="adjustment-title"><strong>è°ƒæ•´ç»æœŸè®°å½•ï¼š</strong></p>';

                    data.end_candidate_records.forEach(function(record, index) {
                        var predictionStatus = record.is_predicted ? ' (é¢„æµ‹)' : ' (ç¡®è®¤)';

                        actionsHtml += '<div class="record-adjustment">';
                        actionsHtml += '<p class="record-info">' + record.start_date + ' å¼€å§‹' + predictionStatus + '</p>';

                        // è®¾ç½®ä¸ºå¼€å§‹æ—¥æœŸ
                        actionsHtml += '<button class="btn btn-pink btn-xs set-start-date" ' +
                                      'data-record-id="' + record.id + '" ' +
                                      'data-date="' + dateStr + '">è®¾ä¸ºå¼€å§‹æ—¥æœŸ</button>';

                        // è°ƒæ•´ä¸ºæ•´ä¸ªæœŸé—´
                        actionsHtml += '<button class="btn btn-pink btn-xs adjust-period" ' +
                                      'data-record-id="' + record.id + '" ' +
                                      'data-start-date="' + record.start_date + '" ' +
                                      'data-end-date="' + dateStr + '">è°ƒæ•´ä¸º ' + record.start_date + ' è‡³ ' + dateStr + '</button>';

                        actionsHtml += '</div>';

                        if (index < data.end_candidate_records.length - 1) {
                            actionsHtml += '<hr class="record-separator">';
                        }
                    });

                    actionsHtml += '</div>';
                    addDebugInfo("æ˜¾ç¤º" + data.end_candidate_records.length + "æ¡å¯è°ƒæ•´è®°å½•");
                } else {
                    if (!data.is_start_possible) {
                        actionsHtml += '<p class="text-muted">è¯¥æ—¥æœŸå·²æœ‰ç»æœŸè®°å½•</p>';
                        addDebugInfo("è¯¥æ—¥æœŸå·²æœ‰ç»æœŸè®°å½•");
                    }
                }
            } else {
                actionsHtml += '<p class="text-muted">è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ç»æœŸè®°å½•åŠŸèƒ½</p>';
                addDebugInfo("ç”¨æˆ·æœªç™»å½•");
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†å¼€å§‹æŒ‰é’®ï¼Œå¦‚æœæ²¡æœ‰ä½†å¯ä»¥å¼€å§‹ï¼Œåˆ™æ·»åŠ 
            if (isUserAuthenticated && data.is_start_possible && !hasStartButton) {
                actionsHtml += '<button class="btn btn-pink btn-sm mb-2" id="setPeriodStart" data-date="' + dateStr + '">æ ‡è®°ç»æœŸå¼€å§‹</button>';
                addDebugInfo("æ·»åŠ æ ‡è®°ç»æœŸå¼€å§‹æŒ‰é’®");
            }

            actionsHtml += '<button class="btn btn-default btn-sm mt-2" id="clearDate">å…³é—­</button>';

            $('#dateActions').html(actionsHtml);
            showDatePanel();

            // ç»‘å®šæ–°æŒ‰é’®çš„äº‹ä»¶
            bindDatePanelEvents(dateStr);
        }

        // åŸºæœ¬æ“ä½œé¢æ¿
        function showBasicDatePanel(dateStr) {
            console.log("æ˜¾ç¤ºåŸºæœ¬æ—¥æœŸé¢æ¿:", dateStr);
            addDebugInfo("æ˜¾ç¤ºåŸºæœ¬æ—¥æœŸé¢æ¿: " + dateStr);

            var date = new Date(dateStr);
            var formattedDate = date.getFullYear() + 'å¹´' +
                               (date.getMonth() + 1) + 'æœˆ' +
                               date.getDate() + 'æ—¥ (' +
                               getWeekday(date.getDay()) + ')';

            $('#selectedDateText').text(formattedDate);

            var actionsHtml = '';
            var hasStartButton = false;

            if (isUserAuthenticated) {
                if (!hasStartButton) {
                    actionsHtml += '<button class="btn btn-pink btn-sm mb-2" id="setPeriodStart" data-date="' + dateStr + '">æ ‡è®°ç»æœŸå¼€å§‹</button>';
                    hasStartButton = true;
                }

                actionsHtml += '<button class="btn btn-pink btn-sm mb-2" id="setPeriodEnd" data-date="' + dateStr + '">æ ‡è®°ç»æœŸç»“æŸ</button>';
            } else {
                actionsHtml += '<p class="text-muted">è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ç»æœŸè®°å½•åŠŸèƒ½</p>';
            }

            actionsHtml += '<button class="btn btn-default btn-sm" id="clearDate">å…³é—­</button>';

            $('#dateActions').html(actionsHtml);
            showDatePanel();

            // ç»‘å®šäº‹ä»¶
            bindDatePanelEvents(dateStr);
        }

        // æ˜¾ç¤ºæ—¥æœŸé¢æ¿
        function showDatePanel() {
            console.log("æ˜¾ç¤ºé¢æ¿");
            addDebugInfo("æ˜¾ç¤ºæ—¥æœŸè¯¦æƒ…é¢æ¿");
            $('#datePanel').show();
            $('#overlay').show();
        }

        // ç»‘å®šæ—¥æœŸé¢æ¿äº‹ä»¶
        function bindDatePanelEvents(dateStr) {
            // æ ‡è®°ç»æœŸå¼€å§‹
            $('#setPeriodStart').off('click').on('click', function() {
                var date = $(this).data('date');
                console.log("æ ‡è®°ç»æœŸå¼€å§‹:", date);
                addDebugInfo("ç‚¹å‡»æ ‡è®°ç»æœŸå¼€å§‹: " + date);
                setPeriodStart(date);
            });

            // æ ‡è®°ç»æœŸç»“æŸ
            $('#setPeriodEnd').off('click').on('click', function() {
                var date = $(this).data('date');
                console.log("æ ‡è®°ç»æœŸç»“æŸ:", date);
                addDebugInfo("ç‚¹å‡»æ ‡è®°ç»æœŸç»“æŸ: " + date);
                setPeriodEnd(date);
            });

            // è®¾ç½®ä¸ºå¼€å§‹æ—¥æœŸ
            $('.set-start-date').off('click').on('click', function() {
                var recordId = $(this).data('record-id');
                var startDate = $(this).data('date');
                console.log("è®¾ç½®å¼€å§‹æ—¥æœŸ:", recordId, startDate);
                addDebugInfo("ç‚¹å‡»è®¾ç½®å¼€å§‹æ—¥æœŸ: è®°å½•" + recordId + ", æ—¥æœŸ" + startDate);
                adjustPeriod(recordId, startDate, null, 'start');
            });

            // è°ƒæ•´æ•´ä¸ªæœŸé—´
            $('.adjust-period').off('click').on('click', function() {
                var recordId = $(this).data('record-id');
                var startDate = $(this).data('start-date');
                var endDate = $(this).data('end-date');
                console.log("è°ƒæ•´æ•´ä¸ªæœŸé—´:", recordId, startDate, endDate);
                addDebugInfo("ç‚¹å‡»è°ƒæ•´æ•´ä¸ªæœŸé—´: è®°å½•" + recordId + ", " + startDate + " è‡³ " + endDate);
                adjustPeriod(recordId, startDate, endDate, 'both');
            });

            // å…³é—­é¢æ¿
            $('#clearDate').off('click').on('click', closeDatePanel);
        }

        // å…³é—­æ—¥æœŸé¢æ¿
        function closeDatePanel() {
            console.log("å…³é—­é¢æ¿");
            addDebugInfo("å…³é—­æ—¥æœŸè¯¦æƒ…é¢æ¿");
            $('#datePanel').hide();
            $('#overlay').hide();
            $('.calendar-day').removeClass('selected');
        }

        // å…³é—­æŒ‰é’®äº‹ä»¶
        $('#closePanel').click(closeDatePanel);
        $('#overlay').click(closeDatePanel);

        // æ ‡è®°ç»æœŸå¼€å§‹
        function setPeriodStart(dateStr) {
            console.log("æ ‡è®°ç»æœŸå¼€å§‹:", dateStr);
            addDebugInfo("æ‰§è¡Œæ ‡è®°ç»æœŸå¼€å§‹: " + dateStr);

            $.ajax({
                url: '/period/start/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': getCSRFToken(),
                    'start_date': dateStr
                },
                success: function(data) {
                    if (data.success) {
                        addDebugInfo("æ ‡è®°ç»æœŸå¼€å§‹æˆåŠŸ");
                        alert('ç»æœŸå¼€å§‹æ ‡è®°æˆåŠŸï¼');
                        closeDatePanel();
                        location.reload();
                    } else {
                        addDebugInfo("æ ‡è®°ç»æœŸå¼€å§‹å¤±è´¥: " + data.message);
                        alert('æ ‡è®°å¤±è´¥: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    addDebugInfo("æ ‡è®°ç»æœŸå¼€å§‹è¯·æ±‚å¤±è´¥: " + error);
                    alert('è¯·æ±‚å¤±è´¥: ' + error);
                }
            });
        }

        // æ ‡è®°ç»æœŸç»“æŸ
        function setPeriodEnd(dateStr) {
            console.log("æ ‡è®°ç»æœŸç»“æŸ:", dateStr);
            addDebugInfo("æ‰§è¡Œæ ‡è®°ç»æœŸç»“æŸ: " + dateStr);

            $.ajax({
                url: '/period/end/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': getCSRFToken(),
                    'end_date': dateStr
                },
                success: function(data) {
                    if (data.success) {
                        addDebugInfo("æ ‡è®°ç»æœŸç»“æŸæˆåŠŸ");
                        alert('ç»æœŸç»“æŸæ—¥æœŸå·²æˆåŠŸæ›´æ–°ï¼');
                        closeDatePanel();
                        location.reload();
                    } else {
                        addDebugInfo("æ ‡è®°ç»æœŸç»“æŸå¤±è´¥: " + data.message);
                        alert('æ ‡è®°å¤±è´¥: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    addDebugInfo("æ ‡è®°ç»æœŸç»“æŸè¯·æ±‚å¤±è´¥: " + error);
                    alert('è¯·æ±‚å¤±è´¥: ' + error);
                }
            });
        }

        // è°ƒæ•´ç»æœŸè®°å½•
        function adjustPeriod(recordId, startDate, endDate, action) {
            console.log("è°ƒæ•´ç»æœŸè®°å½•:", recordId, startDate, endDate, action);
            addDebugInfo("æ‰§è¡Œè°ƒæ•´ç»æœŸè®°å½•: è®°å½•" + recordId + ", æ“ä½œ" + action);

            var requestData = {
                'csrfmiddlewaretoken': getCSRFToken(),
                'record_id': recordId,
                'action': action
            };

            if (startDate) requestData.start_date = startDate;
            if (endDate) requestData.end_date = endDate;

            $.ajax({
                url: '/period/adjust/',
                type: 'POST',
                data: requestData,
                success: function(data) {
                    if (data.success) {
                        addDebugInfo("è°ƒæ•´ç»æœŸè®°å½•æˆåŠŸ");
                        alert('ç»æœŸè®°å½•å·²æˆåŠŸè°ƒæ•´ï¼');
                        closeDatePanel();
                        location.reload();
                    } else {
                        addDebugInfo("è°ƒæ•´ç»æœŸè®°å½•å¤±è´¥: " + data.message);
                        alert('è°ƒæ•´å¤±è´¥: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    addDebugInfo("è°ƒæ•´ç»æœŸè®°å½•è¯·æ±‚å¤±è´¥: " + error);
                    alert('è¯·æ±‚å¤±è´¥: ' + error);
                }
            });
        }

        // è·å–CSRFä»¤ç‰Œ
        function getCSRFToken() {
            var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            if (!csrfToken) {
                var cookieMatch = document.cookie.match(/csrftoken=([^;]+)/);
                csrfToken = cookieMatch ? cookieMatch[1] : '';
            }
            return csrfToken;
        }

        // å°†æ˜ŸæœŸæ•°å­—è½¬æ¢ä¸ºä¸­æ–‡
        function getWeekday(day) {
            var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return 'æ˜ŸæœŸ' + weekdays[day];
        }

        // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æœ¬æœˆï¼Œè‡ªåŠ¨é«˜äº®ä»Šå¤©
        var today = new Date();
        var currentYear = today.getFullYear();
        var currentMonth = today.getMonth() + 1;

        if ({{ current_year }} === currentYear && {{ current_month }} === currentMonth) {
            // é¡µé¢åŠ è½½åé«˜äº®ä»Šå¤©
            setTimeout(highlightToday, 500);
        }

        // å…¶ä»–åŠŸèƒ½ä¿æŒä¸å˜
        // ä¿å­˜åŸºç¡€ä¿¡æ¯
        $('#saveProfile').click(function() {
            var formData = $('#profileForm').serialize();

            $.ajax({
                url: '/period/set-profile-ajax/',
                type: 'POST',
                data: formData,
                success: function(data) {
                    if (data.success) {
                        alert('åŸºç¡€ä¿¡æ¯ä¿å­˜æˆåŠŸ');
                        $('#profileModal').modal('hide');
                        location.reload();
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('è¯·æ±‚å¤±è´¥: ' + error);
                }
            });
        });

        // åˆ é™¤ç»æœŸè®°å½•
        $(document).on('click', '.delete-record', function(e) {
            e.preventDefault();
            e.stopPropagation();

            var recordId = $(this).data('record-id');
            console.log("åˆ é™¤è®°å½•:", recordId);
            addDebugInfo("ç‚¹å‡»åˆ é™¤è®°å½•: " + recordId);

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç»æœŸè®°å½•å—ï¼Ÿ')) {
                addDebugInfo("å–æ¶ˆåˆ é™¤è®°å½•");
                return;
            }

            $.ajax({
                url: '/period/delete/' + recordId + '/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': getCSRFToken()
                },
                success: function(data) {
                    if (data.success) {
                        addDebugInfo("åˆ é™¤è®°å½•æˆåŠŸ");
                        alert('è®°å½•åˆ é™¤æˆåŠŸ');
                        location.reload();
                    } else {
                        addDebugInfo("åˆ é™¤è®°å½•å¤±è´¥: " + data.message);
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    addDebugInfo("åˆ é™¤è®°å½•è¯·æ±‚å¤±è´¥: " + error);
                    alert('è¯·æ±‚å¤±è´¥: ' + error);
                }
            });
        });

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹è°ƒè¯•ä¿¡æ¯
        addDebugInfo("é¡µé¢åŠ è½½å®Œæˆï¼Œç³»ç»Ÿå·²å¯åŠ¨");
        addDebugInfo("å½“å‰ç”¨æˆ·: " + (isUserAuthenticated ? currentUser : "æœªç™»å½•"));
        addDebugInfo("ç›®æ ‡æœˆä»½: {{ current_year }}å¹´{{ current_month }}æœˆ");

        console.log("=== æ‰€æœ‰äº‹ä»¶ç»‘å®šå®Œæˆ ===");
    });
</script>

<style>
/* ä»Šå¤©æŒ‰é’®æ ·å¼ */
.btn-info {
    background-color: #5bc0de;
    border-color: #46b8da;
    color: white;
}

.btn-info:hover {
    background-color: #31b0d5;
    border-color: #269abc;
}

/* ä»Šå¤©æ—¥æœŸé«˜äº®æ ·å¼ */
.today-highlight {
    background-color: #ffffcc !important;
    box-shadow: 0 0 0 2px #ffcc00;
    position: relative;
    z-index: 10;
}

.today-highlight-animate {
    animation: pulse 1s 2.7;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 204, 0, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(255, 204, 0, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 204, 0, 0);
    }
}

/* æœªæ¥æ—¥æœŸæ ·å¼ - ä¸å¯ç‚¹å‡» */
.future-day {
    cursor: not-allowed;
    opacity: 0.7;
    position: relative;
}

.non-clickable {
    pointer-events: none;
}

/* ç¡®ä¿é«˜äº®åœ¨å„ç±»æ—¥æœŸæ ·å¼ä¹‹ä¸Š */
.period-day.today-highlight {
    background: linear-gradient(135deg, #ffe6e6, #ffffcc) !important;
}

.predicted-day.today-highlight {
    background: linear-gradient(135deg, #e7f5ff, #ffffcc) !important;
}

.other-month.today-highlight {
    background: linear-gradient(135deg, #f9f9f9, #ffffcc) !important;
}

.future-day.today-highlight {
    background: linear-gradient(135deg, #f8f9fa, #ffffcc) !important;
}

/* å›¾ä¾‹æ ·å¼ */
.calendar-legend {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 0 10px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    margin-right: 5px;
}



.future-color {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.legend-text {
    font-size: 14px;
    color: #666;
}



/* å¢å¼ºé¢„æµ‹æ—¥æœŸçš„èƒŒæ™¯è‰² - çº¯è“è‰²ç‰ˆæœ¬ */
.current-prediction {
    background-color: #e7f5ff !important;
    border: 1px solid #a5d8ff !important;

}

.next-prediction {
    background-color: #e3f2fd !important;
    border: 1px dashed #4fc3f7 !important;

}
    /* ç»æœŸæ ·å¼ - æœ€é«˜ä¼˜å…ˆçº§ */
.calendar-day.period-day {
    background: #ffe6e6 !important;
    border: 1px solid #ffe6e6 !important;
    position: relative;
    z-index: 20; /* é«˜äºé¢„æµ‹æ ·å¼ */
}

/* é¢„æµ‹æ ·å¼ - è¾ƒä½ä¼˜å…ˆçº§ */
.calendar-day.current-prediction {
    background: #e7f5ff !important;
    border: 1px solid #a5d8ff !important;
    z-index: 10;
}

.calendar-day.next-prediction {
    background: #e3f2fd !important;
    border: 1px dashed #4fc3f7 !important;
    z-index: 10;
}

/* ç¡®ä¿ç»æœŸæ ‡è®°åœ¨é¢„æµ‹æ ‡è®°ä¹‹ä¸Š */
.period-day.current-prediction,
.period-day.next-prediction {
    /* ç»æœŸæ—¥æœŸä¸åº”è¯¥æœ‰é¢„æµ‹æ ·å¼ */
    background: #ffe6e6 !important;
    border: 1px solid #ffe6e6 !important;
}
/* ä¿®å¤æ—¥å†ç½‘æ ¼å¸ƒå±€ - è§£å†³ç¼éš™åç§»é—®é¢˜ */
.calendar-week {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    width: 100%;
    /* å…³é”®ä¿®å¤ï¼šç¡®ä¿ç²¾ç¡®çš„ç½‘æ ¼è®¡ç®— */
    gap: 0; /* ç§»é™¤ç½‘æ ¼é—´éš™ï¼Œä½¿ç”¨è¾¹æ¡†ä»£æ›¿ */
}

.calendar-day {
    /* ç¡®ä¿ç²¾ç¡®çš„å°ºå¯¸è®¡ç®— */
    box-sizing: border-box;
    width: 100%;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;

    /* ç»Ÿä¸€çš„è¾¹æ¡†è®¾ç½® */
    border: 1px solid #e9ecef;
    margin: -0.5px; /* ä¿®å¤è¾¹æ¡†é‡å é—®é¢˜ */
}

/* ä¿®å¤å…¶ä»–æœˆä»½æ—¥æœŸçš„è¾¹æ¡†å¯¹é½ */
.calendar-day.other-month {
    border-color: #f0f0f0;
}

/* ç¡®ä¿æ‰€æœ‰æ—¥æœŸå•å…ƒæ ¼å°ºå¯¸ä¸€è‡´ */
.calendar-day::before {
    content: '';

    display: block;
}

.calendar-day > * {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    text-align: center;
}

/* ä¿®å¤é¢„æµ‹æ ‡è®°ä½ç½® */
.prediction-indicator {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #ff6b9d;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    z-index: 5;
}

/* å¢å¼ºç½‘æ ¼ç²¾åº¦ - ä½¿ç”¨åˆ†æ•°å•ä½ */
.calendar-days {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.calendar-week {
    display: flex;
    width: 100%;
}

.calendar-day {
    flex: 1;
    min-width: 0; /* å…³é”®ä¿®å¤ï¼šé˜²æ­¢å†…å®¹æº¢å‡ºå½±å“å¸ƒå±€ */
    aspect-ratio: 1; /* ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹ */
}

/* é’ˆå¯¹å…·ä½“é—®é¢˜çš„ä¿®å¤ï¼š8å’Œ9ä¹‹é—´çš„ç¼éš™ */
.calendar-week .calendar-day:nth-child(7),  /* ç¬¬7ä¸ªæ ¼å­ï¼ˆå‘¨å…­ï¼‰ */
.calendar-week .calendar-day:nth-child(1) {  /* ç¬¬1ä¸ªæ ¼å­ï¼ˆå‘¨æ—¥ï¼‰ */
    border-right: 1px solid #e9ecef;
}

.calendar-week .calendar-day:nth-child(8) {  /* ç†è®ºä¸Šä¸å­˜åœ¨ï¼Œä½†ç”¨äºä¿®å¤ç›¸é‚»æ ¼å­ */
    border-left: 1px solid transparent; /* ä¿æŒå¯¹é½ */
}
/* å¤šé€‰åˆ é™¤ç›¸å…³æ ·å¼ */
.batch-operations-toolbar {
    border: 1px solid #ddd;
    background: #f8f9fa;
}

.record-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.record-item:hover {
    background-color: #f5f5f5;
}

.record-item.selected {
    background-color: #e3f2fd;
    border-left: 3px solid #2196f3;
}

.record-checkbox {
    margin-right: 10px;
    flex-shrink: 0;
}

.record-checkbox-input {
    margin: 0;
    transform: scale(1.2);
}

.record-content {
    flex-grow: 1;
}

.record-actions {
    flex-shrink: 0;
    margin-left: 10px;
}

.selected-count {
    color: #666;
    font-size: 14px;
}

#batchDeleteBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .batch-operations-toolbar .row > div {
        margin-bottom: 5px;
    }

    .batch-operations-toolbar .text-right {
        text-align: left !important;
    }
}

/* åŸæœ‰çš„å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
/* ... æ‚¨åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ ... */




</style>
{% endblock %}